<?xml version="1.0" encoding="UTF-8" ?>
<queries>
    <query name="GetNextMusicOnUserQueueByUserId">
        SELECT nome,
        duracao_ms AS duracaoMs,
        id_musica AS idMusica
        FROM usuario_fila
        WHERE id_usuario = @idUsuario
        ORDER BY posicao ASC
        LIMIT 1;
    </query>
    <query name="GetMusicAudioByMusicId">
        SELECT audio
        FROM musica
        WHERE id_musica = @idMusica;
    </query>
    <query name="SearchMusicByName">
        SELECT DISTINCT
        m.id_musica AS idMusica,
        m.nome AS nomeMusica
        FROM musica m
        LEFT JOIN artista_musica am ON m.id_musica = am.id_musica
        LEFT JOIN artista a ON am.id_artista = a.id_artista
        LEFT JOIN genero g ON m.id_genero = g.id_genero
        WHERE
        m.nome ILIKE '%' || @nome || '%' OR
        a.nome_artistico ILIKE '%' || @nome || '%' OR
        g.nome ILIKE '%' || @nome || '%';
        ORDER BY m.nome;
    </query>
    <query name="GetMostLikedMusics">
        SELECT
        m.id_musica AS idMusica,
        m.nome AS nome,
        COUNT(au.gostou) AS total_curtidas
        FROM avaliacao_usuario au
        JOIN musica m ON au.id_musica = m.id_musica
        WHERE au.gostou = TRUE
        GROUP BY m.id_musica, m.nome
        ORDER BY total_curtidas DESC
        LIMIT 5;
    </query>
    <query name="GetMostDislikedMusics">
        SELECT
        m.id_musica AS idMusica,
        m.nome AS nome,
        COUNT(au.gostou) AS total_descurtidas
        FROM avaliacao_usuario au
        JOIN musica m ON au.id_musica = m.id_musica
        WHERE au.gostou = FALSE
        GROUP BY m.id_musica, m.nome
        ORDER BY total_descurtidas DESC
        LIMIT 5;
    </query>
    <query name="GetTotalMusics">
        SELECT COUNT(*) AS total
        FROM musica;
    </query>
    <query name="UpdateMusicAudio">
        UPDATE musica
        SET audio = @audio
        WHERE id_musica = @idMusica;
    </query>
    <query name="GetMusicById">
        SELECT
        id_musica AS idMusica,
        nome AS nome,
        duracao_ms AS duracaoMs
        FROM musica
        WHERE id_musica = @idMusica;
    </query>
    <query name="SetOrInsertMusicUserRating">
        INSERT INTO avaliacao_usuario
        (gostou, id_usuario, id_musica)
        VALUES (@liked, @idUsuario, @idMusica)
        DO
        UPDATE
        SET gostou = EXCLUDED.gostou,
        data_avaliacao = CURRENT_TIMESTAMP;
    </query>
    <query name="DeleteUserRating">
        DELETE FROM avaliacao_usuario
        WHERE id_usuario = @idUsuario
        AND id_musica = @idMusica;
    </query>
</queries>
